#!/usr/bin/env python

import sys, os
import numpy as np
from argparse import ArgumentParser
from psycopg2 import connect
from psycopg2.extras import execute_batch, Json

from ase.io import read

default_db = 'postgresql://localhost/abcd-test'

parser = ArgumentParser(description='import xyz files to database')
parser.add_argument('--db', 
    help=("""database connection string - 
    defaults to ABCD_DB environment variable 
    or %s if not ABCD_DB is not set""" % default_db),
    default= os.getenv('ABCD_DB', default_db))
parser.add_argument('filename', nargs='+',
    help='file(s) to be imported')

args = parser.parse_args()

db = connect(args.db)

def info(frame):
    frame_info = frame.info.copy()
    frame_info['total_energy'] = frame.get_total_energy()

    return {k:Json({kk:(vv.tolist() if isinstance(vv, np.ndarray) else vv) for kk,vv in v.items() })
        for k,v in {'info':frame_info, 'atom':frame.arrays}.items()}

with db:
    for filename in args.filename:
        execute_batch(db.cursor(), "insert into frame_raw (info) values (%(info)s)",
            [info(frame) for frame in read(filename, ':')], page_size=500)
